<script>
  const API_KEY = "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";

  async function sendToMistral() {
    const text = document.getElementById("inputText").value.trim();
    if (!text) return;
    saveToHistory("User: " + text);
    const responseBox = document.getElementById("response");
    responseBox.textContent = "Thinking...";

    try {
      const response = await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.1", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${API_KEY}`,
        },
        body: JSON.stringify({
          inputs: text,
          parameters: {
            temperature: 0.7,
            max_new_tokens: 1000
          }
        })
      });

      if (!response.ok) {
        const errorDetails = await response.text();
        console.error(`HTTP ${response.status}:`, errorDetails);
        throw new Error(`Server responded with ${response.status}`);
      }

      const data = await response.json();
      const reply = data[0]?.generated_text || "No response.";
      responseBox.textContent = reply;
      saveToHistory("AI: " + reply);
    } catch (err) {
      console.error("Fetch Error:", err);
      responseBox.textContent = `An error occurred: ${err.message}`;
    }
  }

  function saveToHistory(content) {
    const history = JSON.parse(localStorage.getItem("ai_history") || "[]");
    history.push({ page: "AI", content, timestamp: new Date().toISOString() });
    localStorage.setItem("ai_history", JSON.stringify(history));
  }

  function handleFile(event) {
    const file = event.target.files[0];
    if (file) readFile(file);
  }

  function handleDrop(event) {
    event.preventDefault();
    const file = event.dataTransfer.files[0];
    if (file) readFile(file);
  }

  function handleImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    Tesseract.recognize(file, "eng").then(({ data: { text } }) => {
      document.getElementById("inputText").value = text;
    });
  }

  function readFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      document.getElementById("inputText").value = e.target.result;
    };
    if (file.type === "application/pdf") {
      alert("PDF detected. Parsing not yet implemented.");
    } else {
      reader.readAsText(file);
    }
  }

  const primary = localStorage.getItem("primaryColor");
  const secondary = localStorage.getItem("secondaryColor");
  if (primary) document.documentElement.style.setProperty("--primary-color", primary);
  if (secondary) document.documentElement.style.setProperty("--secondary-color", secondary);
</script>
